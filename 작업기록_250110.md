# Climate2026 작업 기록 (2025-01-10)

## 프로젝트 개요
- **프로젝트명**: 경기도 기후안전 허브 (Climate Safety Hub)
- **기술스택**: React 19 + TypeScript + Vite + Leaflet
- **주요 기능**: 침수 위험 지도, WMS/WFS 데이터 연동

---

## 완료된 작업

### 1. 하단 통계 카드 상세 모달 구현

3개의 통계 카드를 클릭하면 상세 정보를 볼 수 있도록 모달 추가:

#### 1-1. 침수위험도 카드 (`handleDangerCardClick`)
- 위험 등급 시각화 (원형 배지 + 색상)
- 홍수위험지수 점수 (0~1 범위, 100점 환산)
- 31개 시군 중 순위 표시
- 점수 진행바 시각화
- 데이터 출처 안내 문구

#### 1-2. 취약시설 카드 (`handleFacilityCardClick`)
- 시설명, 시설유형, 주소 표시
- 좌표 정보 (있는 경우)
- 위험등급 (있는 경우)
- 전체 시설 목록 스크롤 가능

#### 1-3. 침수흔적 카드 (`handleTraceCardClick`)
- 메타데이터 그리드 레이아웃
- 발생일자, 침수깊이, 침수면적, 침수원인
- 좌표 정보 개선된 표시
- 상세 정보 유무 표시
- 개발모드에서 원본 속성 디버그 토글

---

### 2. 침수흔적 마커 표시 기능

#### 2-1. WFS 좌표계 문제 해결
**문제**: GeoServer가 EPSG:5186(한국 중부원점, 미터 단위) 좌표를 반환하여 Leaflet에서 마커가 표시되지 않음

**해결**: `wfsService.ts`에서 WFS 요청 시 `srsName=EPSG:4326` 파라미터 추가
```typescript
// WGS84 좌표계로 요청 (Leaflet 호환)
url.searchParams.set('srsName', params.srsName || 'EPSG:4326');
```

#### 2-2. 좌표 추출 로직 개선 (`getMarkerPosition`)
- GeoJSON 타입별 좌표 추출 (Point, Polygon, MultiPolygon)
- 좌표 유효성 검사 (경기도 범위: lat 36~39, lng 125~130)
- EPSG:5186 좌표 감지 시 대략적 변환 시도 (폴백)
- 상세 디버깅 로그 추가

#### 2-3. 마커 토글 버튼 개선
**변경 전**: `📍 104개`
**변경 후**: `📍 침수흔적 104건`

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `frontend/src/services/wfsService.ts` | WFS 좌표계 지정 (EPSG:4326), 취약시설 상세 조회 함수 추가 |
| `frontend/src/pages/MapPage.tsx` | 3개 카드 클릭 모달, 마커 좌표 추출 로직 개선, 마커 토글 버튼 텍스트 |
| `frontend/src/index.css` | 모달 스타일, 위험도 분석 UI, 시설 목록 스타일 |

---

## 주요 타입 정의

### WeakFacilityDetail (취약시설 상세)
```typescript
export type WeakFacilityDetail = {
  id: string;
  facilityName: string;       // 시설명
  facilityType: string;       // 시설유형
  address: string;            // 주소
  coordinates?: string;       // 좌표
  riskLevel?: string;         // 위험등급
  properties: Record<string, unknown>;
};
```

### FloodTraceDetail (침수흔적 상세)
```typescript
export type FloodTraceDetail = {
  id: string;
  stdgSggCd: string;           // 시군구코드
  address?: string;            // 주소
  occurDate?: string;          // 발생일자
  floodDepth?: number;         // 침수깊이
  floodArea?: number;          // 침수면적
  cause?: string;              // 침수원인
  geometryType?: string;       // geometry 타입
  coordinates?: string;        // 좌표 문자열
  geometry?: {...};            // 원본 geometry (마커용)
  properties: Record<string, unknown>;
  hasDetailInfo: boolean;
};
```

---

## WMS/WFS 레이어 정보

| 레이어 ID | 레이어명 | 용도 |
|-----------|----------|------|
| spggcee:tm_fldn_trce | 침수흔적 | 과거 침수 발생 지점 |
| spggcee:tm_sigun_flod_dngr_evl_rnk | 위험도순위 | 홍수위험평가 결과 |
| spggcee:flod_weak_fclt | 취약시설 | 침수 취약시설 위치 |
| spggcee:lsmd_cont_uj301_41 | 하천·소하천 | 하천 경계 |

---

## 동작 확인 체크리스트

- [x] 시/군 선택 시 지도 이동
- [x] 하단 3개 통계 카드 데이터 표시
- [x] 침수위험도 카드 클릭 → 상세 모달
- [x] 취약시설 카드 클릭 → 시설 목록 모달
- [x] 침수흔적 카드 클릭 → 흔적 목록 모달
- [x] 침수흔적 마커 지도에 표시
- [x] 마커 토글 버튼 동작
- [x] 마커 클릭 시 팝업 표시
- [x] WMS 레이어 탭 전환
- [x] 투명도 슬라이더 동작
- [x] 빌드 에러 없음

---

## 실행 방법

```bash
cd D:/climate2026/frontend
npm run dev
```

브라우저에서 http://localhost:5173 접속

---

## 다음 작업 (예정)

- [ ] 취약시설 마커 표시 기능
- [ ] 마커 클러스터링 (많은 마커 그룹화)
- [ ] 모바일 반응형 최적화
- [ ] 제보 기능 구현
